<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <title>TS Monaco → /api/file → Worker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121a30;
      --muted: #93a1c0;
      --accent: #4fa3ff;
      --ok: #1fbf75;
      --err: #ff6161;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #eaf0ff;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid #1f2b4a;
      background: #0e1630
    }

    h1 {
      margin: 0;
      font-size: 16px
    }

    .bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      padding: 10px 16px;
      background: #0f1730;
      border-bottom: 1px solid #1f2b4a
    }

    input[type="text"] {
      background: #0f1730;
      border: 1px solid #2a375a;
      border-radius: 10px;
      color: #eaf0ff;
      padding: 8px 10px;
      min-width: 0
    }

    .grow {
      flex: 1 1 220px
    }

    button {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 700;
      padding: 9px 14px;
      cursor: pointer
    }

    button.secondary {
      background: #25355f;
      color: #cfe3ff
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed
    }

    .wrap {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 10px;
      padding: 10px;
      height: calc(100vh - 100px);
    }

    #editor {
      width: 100%;
      height: 100%;
      border: 1px solid #1f2b4a;
      border-radius: 12px;
      overflow: hidden
    }

    .side {
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%
    }

    .card {
      background: var(--panel);
      border: 1px solid #1f2b4a;
      border-radius: 12px;
      padding: 12px
    }

    .muted {
      color: var(--muted);
      font-size: .9rem
    }

    #log {
      height: 220px;
      background: #0f1730;
      border: 1px solid #2a375a;
      border-radius: 10px;
      padding: 10px;
      overflow: auto;
      font: 12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace
    }

    code.inline {
      background: #16234b;
      border: 1px solid #2a375a;
      padding: 1px 6px;
      border-radius: 6px
    }

    a {
      color: #9ecbff
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .ok {
      color: var(--ok)
    }

    .err {
      color: var(--err)
    }
  </style>
  <script>window.MONACO_BASE = "https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min";</script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script>
</head>

<body>
  <header>
    <h1>Éditeur TypeScript → Enregistrer & Exécuter dans un Worker</h1>
  </header>

  <div class="bar">
    <span class="muted">Chemin de sortie</span>
    <input id="folder" class="grow" type="text" value="scripts" placeholder="dossier (ex: scripts)" />
    <input id="fname" class="grow" type="text" value="worker.ts" placeholder="fichier (ex: worker.ts)" />
    <button id="saveRun">Enregistrer & Exécuter (Ctrl/Cmd+S)</button>
    <button id="stop" class="secondary">Stop</button>
  </div>

  <div class="wrap">
    <div id="editor"></div>
    <div class="side">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">URL Worker (transpilé):</div>
            <div id="workerUrl"><code class="inline">/scripts/worker.js</code></div>
          </div>
          <button id="format" class="secondary">Formater</button>
        </div>
      </div>

      <div class="card">
        <div class="muted">Log Worker</div>
        <div id="log"></div>
        <div class="row" style="margin-top:8px">
          <input id="msg" class="grow" type="text" placeholder="message à envoyer au worker…" />
          <button id="send" class="secondary">Envoyer</button>
        </div>
        <div id="status" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <div class="muted">Notes</div>
        <ul class="muted" style="margin:8px 0 0 18px">
          <li>On enregistre en <code class="inline">application/typescript; charset=utf-8</code>.</li>
          <li>Le Worker est lancé sur <code class="inline">.js</code> (transpilé par ton middleware TS→JS).</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const folderEl = $('#folder');
    const fnameEl = $('#fname');
    const saveRun = $('#saveRun');
    const stopBtn = $('#stop');
    const formatBtn = $('#format');
    const logEl = $('#log');
    const statusEl = $('#status');
    const msgEl = $('#msg');
    const sendBtn = $('#send');
    const workerUrlEl = $('#workerUrl');

    let editor, model, worker = null;

    function log(line, cls) {
      const el = document.createElement('div');
      if (cls) el.className = cls;
      el.textContent = line;
      logEl.appendChild(el);
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setStatus(txt, cls) {
      statusEl.className = cls ? cls + ' muted' : 'muted';
      statusEl.textContent = txt;
    }
    function sanitizeSegment(s) {
      return (s || '').replace(/^\/+|\/+$/g, '').replace(/[^a-zA-Z0-9._\-\/]/g, '_');
    }
    function ensureTs(name) {
      return /\.ts$/i.test(name) ? name : (name + '.ts');
    }
    function jsFromTs(pathTs) {
      return pathTs.replace(/\.ts$/i, '.js');
    }
    function currentPaths() {
      const folder = sanitizeSegment(folderEl.value || 'scripts');
      const fname = ensureTs(sanitizeSegment(fnameEl.value || 'worker.ts'));
      const tsUrlRel = `/${folder}/${fname}`;
      const jsUrlRel = jsFromTs(tsUrlRel);
      return { folder, fname, tsUrlRel, jsUrlRel };
    }
    function updateWorkerUrlPreview() {
      const { jsUrlRel } = currentPaths();
      workerUrlEl.innerHTML = `<code class="inline">${jsUrlRel}</code>`;
    }
    folderEl.addEventListener('input', () => { updateWorkerUrlPreview(); updateModelUri(); });
    fnameEl.addEventListener('input', () => { updateWorkerUrlPreview(); updateModelUri(); });

    // --- Monaco init with file:// URI and eager sync ---
    window.require.config({ paths: { 'vs': window.MONACO_BASE + '/vs' } });
    window.require(['vs/editor/editor.main'], () => {
      monaco.languages.typescript.typescriptDefaults.setEagerModelSync(true);
      monaco.languages.typescript.typescriptDefaults.setCompilerOptions({
        target: monaco.languages.typescript.ScriptTarget.ES2020,
        module: monaco.languages.typescript.ModuleKind.ESNext,
        allowJs: true,
        checkJs: false,
        strict: false,
        allowNonTsExtensions: true,
      });

      const { tsUrlRel } = currentPaths();
      const initialUri = monaco.Uri.parse('file://' + tsUrlRel); // ← URI "fichier" réelle
      const initialCode = `/* Exemple Worker TypeScript */
declare const self: DedicatedWorkerGlobalScope;
export {};

function log(...args:any[]) {
  self.postMessage({ type:'log', data: args.map(x => typeof x==='object' ? JSON.stringify(x) : String(x)) });
}

log("👋 Worker TS démarré", new Date().toISOString());

self.onmessage = (e: MessageEvent) => {
  log("Message reçu:", e.data);
  if (e.data === "ping") self.postMessage("pong");
};

let n = 0;
setInterval(() => self.postMessage({ tick: ++n, at: Date.now() }), 1000);
`;
      model = monaco.editor.createModel(initialCode, 'typescript', initialUri);

      editor = monaco.editor.create(document.getElementById('editor'), {
        model,
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 13,
        minimap: { enabled: false },
        tabSize: 2,
      });

      updateWorkerUrlPreview();
    });

    function updateModelUri() {
      if (!window.monaco || !model) return;
      const { tsUrlRel } = currentPaths();
      const newUri = monaco.Uri.parse('file://' + tsUrlRel);
      if (String(model.uri) === String(newUri)) return;
      const value = model.getValue();
      const newModel = monaco.editor.createModel(value, 'typescript', newUri);
      editor.setModel(newModel);
      model.dispose();
      model = newModel;
    }

    async function saveFile() {
      const { folder, fname, tsUrlRel } = currentPaths();

      if (folder.includes('..') || fname.includes('..')) throw new Error("Chemin invalide ('..')");
      const apiUrl = `/api/file/${encodeURIComponent(folder)}/${encodeURIComponent(fname)}`;
      const src = editor.getValue();
      const rep = await fetch("/api/get-config", { method: 'POST' })
      const value = await rep.json()
      await fetch("/api/current-directory", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: value.code })
      })
      const resp = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/typescript; charset=utf-8' },
        body: new TextEncoder().encode(src)
      });

      const json = await resp.json().catch(() => ({}));
      if (!resp.ok || !json.ok) throw new Error(json.message || `Erreur HTTP ${resp.status}`);
      return { tsUrlRel };
    }

    function startWorker() {
      const { jsUrlRel } = currentPaths();
      const url = `${jsUrlRel}?t=${Date.now()}`;
      if (worker) { worker.terminate(); worker = null; }

      try {
        worker = new Worker(url, { type: 'module' });
        worker.onmessage = (ev) => {
          const d = ev.data;
          if (d && typeof d === 'object' && d.type === 'log') log(d.data.join(' '));
          else log(`↩︎ ${typeof d === 'object' ? JSON.stringify(d) : String(d)}`);
        };
        worker.onerror = (e) => { log(`Erreur Worker: ${e.message || e.filename || e.lineno}`, 'err'); setStatus('Erreur Worker', 'err'); };
        setStatus('Worker démarré', 'ok');
        log(`▶️ Worker lancé: ${jsUrlRel}`, 'ok');
      } catch (e) {
        log(`Impossible de démarrer le Worker: ${e.message || e}`, 'err');
        setStatus('Échec démarrage Worker', 'err');
      }
    }

    async function saveAndRun() {
      setStatus('Enregistrement…');
      try {
        await saveFile();
        setStatus('Fichier enregistré', 'ok');
        startWorker();
      } catch (e) {
        setStatus(e.message || String(e), 'err');
        log(`❌ ${e.message || e}`, 'err');
      }
    }

    $('#saveRun').addEventListener('click', saveAndRun);
    $('#format').addEventListener('click', () => editor && editor.getAction('editor.action.formatDocument').run());
    $('#stop').addEventListener('click', () => { if (worker) { worker.terminate(); worker = null; setStatus('Worker stoppé'); log('⏹️ Worker stoppé'); } });
    $('#send').addEventListener('click', () => { if (worker) { worker.postMessage($('#msg').value); log(`→ ${$('#msg').value}`); $('#msg').value = ''; } });

    // Ctrl/Cmd+S = save & run
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        saveAndRun();
      }
    });
  </script>
</body>

</html>