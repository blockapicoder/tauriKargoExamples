<!doctype html>
<meta charset="utf-8" />
<title>Explorateur (API /api/explorer)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { color-scheme: light dark; }
  * { box-sizing: border-box; }
  body { font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:16px; max-width:1100px; margin-inline:auto; }
  header { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
  h1 { font-size:18px; margin:0 8px 0 0; }
  input, button {
    padding:10px 12px; border-radius:10px; border:1px solid rgba(127,127,127,.35);
    background:inherit; color:inherit;
  }
  button { cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .row { display:flex; gap:8px; flex-wrap:wrap; width:100%; }
  #path { flex:1 1 420px; min-width:280px; }
  #filter { flex:1 1 220px; min-width:200px; }
  .status { margin:8px 0 12px; opacity:.85; min-height:1.2em; }
  .panel { border:1px solid rgba(127,127,127,.35); border-radius:12px; overflow:clip; }
  table { width:100%; border-collapse:collapse; }
  thead th { text-align:left; font-weight:600; background: rgba(127,127,127,.12); padding:10px 12px; position:sticky; top:0; }
  tbody td { padding:8px 12px; border-top:1px solid rgba(127,127,127,.18); }
  tbody tr:hover { background: rgba(127,127,127,.12); }
  .name { display:flex; align-items:center; gap:10px; }
  .path { font-family: ui-monospace, Menlo, Consolas, monospace; opacity:.85; }
  .actions { display:flex; gap:6px; justify-content:flex-end; }
  .empty { padding:16px; text-align:center; opacity:.75; }
  .spinner { width:16px; height:16px; border-radius:50%; border:2px solid rgba(127,127,127,.35); border-top-color:transparent; display:inline-block; animation:spin 1s linear infinite; vertical-align:-3px; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .error { color:#b00020; }
</style>

<header>
  <h1>Explorateur</h1>
  <div class="row">
    <input id="path" type="text" placeholder="Chemin absolu ou relatif (ex: C:\, /, /home/user, D:\Projets)" />
    <button id="go">Aller</button>
    <button id="up">‚¨ÜÔ∏è Parent</button>
    <input id="filter" type="text" placeholder="Filtrer (nom contient‚Ä¶)" />
    <button id="refresh">‚Üª</button>
    <button id="clear">‚úï</button>
  </div>
</header>

<div id="status" class="status"></div>

<section class="panel">
  <table>
    <thead><tr><th>Nom</th><th>Chemin</th><th style="width:160px;">Actions</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
  <div id="empty" class="empty" hidden>Aucun √©l√©ment.</div>
</section>

<script type="module">
const API = "/api/explorer";
const $ = s => document.querySelector(s);
const tbody = $("#tbody"), status = $("#status"), emptyMsg = $("#empty");
const pathInput = $("#path"), filterInput = $("#filter");

let current = { type:"directory", path:"", parent:null, content: [] };

function setBusy(b, msg="") {
  $("#go").disabled = b; $("#up").disabled = b; $("#refresh").disabled = b; $("#clear").disabled = b;
  const spin = b ? ' <span class="spinner"></span>' : '';
  status.innerHTML = msg ? `${msg}${spin}` : (b ? `Chargement‚Ä¶${spin}` : "");
}

function escapeHtml(s=""){return s.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

async function explore(pathStr){
  setBusy(true, `Lecture de <code>${escapeHtml(pathStr||"/")}</code>‚Ä¶`);
  try{
    const res = await fetch(API, {
      method: "POST",
      headers: {"Content-Type":"application/json","Cache-Control":"no-cache"},
      body: JSON.stringify({ path: pathStr||"" })
    });
    const json = await res.json();
    if(!res.ok || json.type==="error") throw new Error(json.message || res.statusText);
    current = json;
    pathInput.value = current.path || pathStr || "";
    render();
    setBusy(false, `OK`);
  }catch(e){
    setBusy(false);
    status.innerHTML = `<span class="error">‚ùå ${escapeHtml(e.message||String(e))}</span>`;
    current = { type:"directory", path:pathStr, parent:null, content: [] };
    render();
  }
}

function render(){
  const filter = (filterInput.value||"").toLowerCase().trim();
  tbody.replaceChildren();

  if(current.type === "file"){
    emptyMsg.hidden = true;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name"><span>üìÑ</span> <strong>${escapeHtml(current.path.split(/[\\/]/).pop()||current.path)}</strong></td>
      <td class="path">${escapeHtml(current.path||"")}</td>
      <td class="actions">
        <button data-act="copy">Copier</button>
        <button data-act="parent">Ouvrir dossier</button>
      </td>`;
    tr.querySelector('[data-act="copy"]').addEventListener("click", async()=>{
      await navigator.clipboard.writeText(current.path||"");
      status.textContent = "Chemin copi√©";
    });
    tr.querySelector('[data-act="parent"]').addEventListener("click", ()=>{
      if(current.parent) explore(current.parent);
    });
    tbody.append(tr);
    return;
  }

  const items = (current.content||[]).filter(it=>!filter || it.name.toLowerCase().includes(filter));
  emptyMsg.hidden = items.length>0;

  for(const it of items){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name"><span>üìÅ</span> <a href="#" class="open">${escapeHtml(it.name)}</a></td>
      <td class="path">${escapeHtml(it.path)}</td>
      <td class="actions">
        <button data-act="open">Ouvrir</button>
        <button data-act="copy">Copier</button>
      </td>`;
    tr.querySelector(".open").addEventListener("click", (e)=>{ e.preventDefault(); explore(it.path); });
    tr.querySelector('[data-act="open"]').addEventListener("click", ()=> explore(it.path));
    tr.querySelector('[data-act="copy"]').addEventListener("click", async()=>{
      await navigator.clipboard.writeText(it.path);
      status.textContent = "Chemin copi√©";
    });
    tbody.append(tr);
  }
}

// actions
$("#go").addEventListener("click", ()=> explore(pathInput.value.trim()));
$("#refresh").addEventListener("click", ()=> explore(pathInput.value.trim()));
$("#clear").addEventListener("click", ()=> { filterInput.value=""; render(); });
$("#up").addEventListener("click", ()=>{
  if(current.parent) explore(current.parent);
});
pathInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") explore(pathInput.value.trim()); });
filterInput.addEventListener("input", render);

// init: racine (chemin relatif vide)
explore("");
</script>
