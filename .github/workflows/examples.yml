name: Manual build examples zips & release (main)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag de release (ex: v1.2.3 ou build-2025-10-17)"
        required: true
      examples_dir:
        description: "Chemin du dossier d'examples"
        required: false
        default: "examples"

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      EXAMPLES_DIR: ${{ github.event.inputs.examples_dir || 'examples' }}
      TAG_NAME: ${{ github.event.inputs.tag_name }}

    steps:
      - name: Checkout main (forced)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            **/package-lock.json
            **/npm-shrinkwrap.json

      - name: Install deps in each example (if package.json exists)
        shell: bash
        run: |
          set -euxo pipefail
          test -d "$EXAMPLES_DIR"

          # Dossiers d'exemples = dossiers (profondeur 1-2) contenant package.json
          mapfile -t dirs < <(find "$EXAMPLES_DIR" -mindepth 1 -maxdepth 2 -type f -name package.json -printf '%h\n' | sort -u)
          test "${#dirs[@]}" -gt 0

          for d in "${dirs[@]}"; do
            echo ">>> Install in $d"
            if [ -f "$d/package-lock.json" ]; then
              (cd "$d" && npm ci)
            else
              (cd "$d" && npm install --no-audit --no-fund)
            fi
          done

      - name: Zip each example directory (keep node_modules)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p artifacts

          mapfile -t dirs < <(find "$EXAMPLES_DIR" -mindepth 1 -maxdepth 2 -type f -name package.json -printf '%h\n' | sort -u)
          test "${#dirs[@]}" -gt 0

          for d in "${dirs[@]}"; do
            rel="${d#"$EXAMPLES_DIR"/}"              # chemin relatif dans examples/
            safe="${rel//\//__}"                     # nom de fichier safe
            zip_name="example-${safe}.zip"

            echo ">>> Zipping $d -> artifacts/$zip_name"
            zip -r "artifacts/$zip_name" "$d" \
              -x "*/.git/*" "*/node_modules/.cache/*"
          done

          echo "Artifacts produced:"
          ls -la artifacts

      - name: Publish GitHub Release (target main)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          target_commitish: main
          name: "Examples with deps – ${{ env.TAG_NAME }}"
          body: |
            Archives par répertoire d’exemple depuis `${{ env.EXAMPLES_DIR }}` (branche `main`),
            avec dépendances préinstallées (`node_modules` conservé).
          files: |
            artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
